# VMware Cluster Capacity Analysis Script - Email Only Version
# Calculates how many hosts can be down before performance degradation

# Connection to multiple vCenter Servers
$vCenterServers = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com", 
    "vcenter3.domain.com"
)

# Configuration - Modify these values as needed
$CpuOvercommitRatio = 2.0             # How much you typically overcommit CPU (2:1 is common)
$MemoryBufferPct = 0.15               # 15% memory buffer for performance
$CpuThresholdPct = 0.80               # 80% CPU threshold before performance issues

# Email Configuration
$SendEmail = $true                     # Set to $false to disable email
$EmailTo = "admin@company.com"         # Recipient email
$EmailFrom = "vmware-reports@company.com" # Sender email
$EmailSubject = "VMware Cluster Capacity Analysis - $(Get-Date -Format 'yyyy-MM-dd')"
$SMTPServer = "mail.company.com"       # Your SMTP server
$SMTPPort = 465                        # SSL port (465 for SSL, 587 for TLS)
$UseSSL = $true                        # Use SSL encryption
$SMTPCredentials = $null               # No SMTP authentication required

# Get credentials once at the start
Write-Host "Please enter your vCenter credentials:" -ForegroundColor Yellow
$Credential = Get-Credential

# Suppress certificate warnings (optional)
Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Confirm:$false -Scope Session

try {
    # Connect to vCenter Servers
    Write-Host "Connecting to vCenter Servers:" -ForegroundColor Green
    
    foreach ($server in $vCenterServers) {
        if (-not [string]::IsNullOrWhiteSpace($server)) {
            $cleanServer = $server.Trim()
            if ($cleanServer -ne "") {
                Write-Host "  Attempting connection to: $cleanServer" -ForegroundColor Cyan
                try {
                    Connect-VIServer -Server $cleanServer -Credential $Credential -ErrorAction Stop
                    Write-Host "    ✓ Connected successfully" -ForegroundColor Green
                } catch {
                    Write-Host "    ✗ Failed to connect: $($_.Exception.Message)" -ForegroundColor Red
                    continue
                }
            }
        }
        
        # Calculate failure scenarios for up to 2 hosts down
        for ($hostsDown = 0; $hostsDown -le [math]::Min(2, $totalHosts - 1); $hostsDown++) {
            $remainingHosts = $totalHosts - $hostsDown
            $remainingCpuMhz = $remainingHosts * $avgCpuPerHost
            $remainingMemoryMB = $remainingHosts * $avgMemoryPerHost
            
            $cpuUtilAfterFailure = [math]::Round(($estimatedCpuDemandMhz / $remainingCpuMhz) * 100, 2)
            $memUtilAfterFailure = [math]::Round(($estimatedMemoryDemandMB / $remainingMemoryMB) * 100, 2)
            
            # Performance risk assessment
            $status = "OK"
            if ($cpuUtilAfterFailure -gt ($CpuThresholdPct * 100)) {
                $status = "CPU PERFORMANCE RISK"
            }
            if ($memUtilAfterFailure -gt ((1 - $MemoryBufferPct) * 100)) {
                $status = if ($status -eq "OK") { "MEMORY PERFORMANCE RISK" } else { "CPU & MEMORY RISK" }
            }
            
            $failureAnalysis += [PSCustomObject]@{
                vCenter = $vCenterName
                Cluster = $cluster.Name
                HostsDown = $hostsDown
                RemainingHosts = $remainingHosts
                CPUUtilization = "$cpuUtilAfterFailure%"
                MemoryUtilization = "$memUtilAfterFailure%"
                Status = $status
            }
        }
    }

    # Get all clusters from all connected vCenter servers
    $clusters = Get-Cluster | Where-Object { $_.HAEnabled -eq $true }
    
    # Initialize results collection for email
    $summaryTable = @()
    $failureAnalysis = @()
    
    Write-Host "`nAnalyzing cluster capacity across all vCenter servers..." -ForegroundColor Yellow
    
    foreach ($cluster in $clusters) {
        # Get the vCenter server this cluster belongs to
        $vCenterName = $cluster.Uid.Split('@')[1].Split(':')[0]
        
        Write-Host "Processing vCenter: $vCenterName, Cluster: $($cluster.Name)" -ForegroundColor Cyan
        
        # Get all connected hosts in cluster
        $hosts = $cluster | Get-VMHost | Where-Object { $_.ConnectionState -eq "Connected" -and $_.PowerState -eq "PoweredOn" }
        $totalHosts = $hosts.Count
        
        if ($totalHosts -lt 2) {
            Write-Host "  Insufficient hosts for analysis (need at least 2)" -ForegroundColor Yellow
            continue
        }
        
        # Calculate total cluster resources
        $totalCpuMhz = ($hosts | Measure-Object -Property CpuTotalMhz -Sum).Sum
        $totalMemoryMB = ($hosts | Measure-Object -Property MemoryTotalMB -Sum).Sum
        $totalCpuCores = ($hosts | Measure-Object -Property NumCpu -Sum).Sum
        
        # Get all powered-on VMs in the cluster
        $vms = $cluster | Get-VM | Where-Object { $_.PowerState -eq "PoweredOn" }
        $totalVMs = $vms.Count
        
        # Calculate VM resource demands (allocated resources)
        $allocatedCpuCores = ($vms | Measure-Object -Property NumCpu -Sum).Sum
        $allocatedMemoryMB = ($vms | Measure-Object -Property MemoryMB -Sum).Sum
        
        # Estimate actual CPU demand (accounting for typical overcommit)
        $estimatedCpuDemandMhz = ($allocatedCpuCores * ($totalCpuMhz / $totalCpuCores)) / $CpuOvercommitRatio
        
        # Memory demand (VMs typically use most of their allocated memory)
        $estimatedMemoryDemandMB = $allocatedMemoryMB * (1 - $MemoryBufferPct)
        
        # Calculate current utilization percentages
        $currentCpuUtilPct = [math]::Round(($estimatedCpuDemandMhz / $totalCpuMhz) * 100, 2)
        $currentMemUtilPct = [math]::Round(($estimatedMemoryDemandMB / $totalMemoryMB) * 100, 2)
        
        # Calculate how much capacity we need per host (average)
        $avgCpuPerHost = $totalCpuMhz / $totalHosts
        $avgMemoryPerHost = $totalMemoryMB / $totalHosts
        
        # Calculate vCPU to pCPU ratio
        $vCpuToPcpuRatio = [math]::Round($allocatedCpuCores / $totalCpuCores, 2)
        
        # Calculate minimum hosts needed to handle current workload within thresholds
        $minHostsForCpu = [math]::Ceiling($estimatedCpuDemandMhz / ($avgCpuPerHost * $CpuThresholdPct))
        $minHostsForMemory = [math]::Ceiling($estimatedMemoryDemandMB / ($avgMemoryPerHost * (1 - $MemoryBufferPct)))
        
        # Most restrictive requirement
        $minHostsNeeded = [math]::Max($minHostsForCpu, $minHostsForMemory)
        $maxHostsCanLose = [math]::Max(0, $totalHosts - $minHostsNeeded)
        
        # HA considerations
        $haFailoverHosts = if ($cluster.HAAdmissionControlEnabled) { $cluster.HAFailoverLevel } else { 0 }
        if ($haFailoverHosts -gt 0) {
            $haConstraint = [math]::Max(0, $totalHosts - $haFailoverHosts - 1)
            if ($haConstraint -lt $maxHostsCanLose) {
                $maxHostsCanLose = $haConstraint
            }
        }
        
        # Add to summary table for email
        $summaryTable += [PSCustomObject]@{
            vCenter = $vCenterName
            Cluster = $cluster.Name
            TotalHosts = $totalHosts
            TotalVMs = $totalVMs
            pCPU = $totalCpuCores
            vCPU = $allocatedCpuCores
            vCpuToPcpuRatio = "$($vCpuToPcpuRatio):1"
            CurrentCPU = "$currentCpuUtilPct%"
            CurrentMemory = "$currentMemUtilPct%"
            MaxHostsDown = $maxHostsCanLose
            HostsDownMessage = if ($maxHostsCanLose -eq 0) { "No hosts can fail" } 
                              elseif ($maxHostsCanLose -eq 1) { "1 host can fail" } 
                              else { "$maxHostsCanLose hosts can fail" }
        }
    }
    
    # Sort the summary table by vCenter and Cluster name
    $summaryTable = $summaryTable | Sort-Object vCenter, Cluster
    $failureAnalysis = $failureAnalysis | Sort-Object vCenter, Cluster, HostsDown
    
    # Send email report if configured
    if ($SendEmail -and $summaryTable.Count -gt 0) {
        Write-Host "`nGenerating email report..." -ForegroundColor Green
        
        # Create HTML email content
        $htmlBody = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #2E8B57; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .summary { background-color: #f5f5f5; padding: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>VMware Cluster Capacity Analysis Report</h1>
    <p><strong>Generated:</strong> $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
    
    <div class="summary">
        <h3>Analysis Parameters</h3>
        <ul>
            <li>CPU Overcommit Ratio: $($CpuOvercommitRatio):1</li>
            <li>CPU Threshold: $($CpuThresholdPct * 100)%</li>
            <li>Memory Buffer: $($MemoryBufferPct * 100)%</li>
        </ul>
    </div>

    <h2>Cluster Summary</h2>
    <table>
        <tr>
            <th>vCenter</th>
            <th>Cluster</th>
            <th>Total Hosts</th>
            <th>Total VMs</th>
            <th>pCPU Cores</th>
            <th>vCPU Assigned</th>
            <th>vCPU:pCPU Ratio</th>
            <th>Current CPU</th>
            <th>Current Memory</th>
            <th>Host Failure Capacity</th>
        </tr>
"@
        
        foreach ($row in $summaryTable) {
            $htmlBody += "<tr>"
            $htmlBody += "<td>$($row.vCenter)</td>"
            $htmlBody += "<td>$($row.Cluster)</td>"
            $htmlBody += "<td>$($row.TotalHosts)</td>"
            $htmlBody += "<td>$($row.TotalVMs)</td>"
            $htmlBody += "<td>$($row.pCPU)</td>"
            $htmlBody += "<td>$($row.vCPU)</td>"
            $htmlBody += "<td>$($row.vCpuToPcpuRatio)</td>"
            $htmlBody += "<td>$($row.CurrentCPU)</td>"
            $htmlBody += "<td>$($row.CurrentMemory)</td>"
            $htmlBody += "<td>$($row.HostsDownMessage)</td>"
            $htmlBody += "</tr>"
        }
        
        $htmlBody += @"
    </table>

    <h2>Detailed Failure Scenarios by Cluster</h2>
"@
        
        # Get unique clusters and process each one individually
        $uniqueClusters = $failureAnalysis | Select-Object vCenter, Cluster -Unique | Sort-Object vCenter, Cluster
        
        foreach ($uniqueCluster in $uniqueClusters) {
            $vCenterName = $uniqueCluster.vCenter
            $clusterName = $uniqueCluster.Cluster
            $displayName = "$vCenterName - $clusterName"
            
            # Get scenarios for this specific cluster
            $clusterScenarios = $failureAnalysis | Where-Object { $_.vCenter -eq $vCenterName -and $_.Cluster -eq $clusterName } | Sort-Object HostsDown
            
            $htmlBody += @"
    <h3>$displayName</h3>
    <table>
        <tr>
            <th>Hosts Down</th>
            <th>Remaining Hosts</th>
            <th>CPU Utilization</th>
            <th>Memory Utilization</th>
            <th>Status</th>
        </tr>
"@
            
            foreach ($scenario in $clusterScenarios) {
                $htmlBody += "<tr>"
                $htmlBody += "<td>$($scenario.HostsDown)</td>"
                $htmlBody += "<td>$($scenario.RemainingHosts)</td>"
                $htmlBody += "<td>$($scenario.CPUUtilization)</td>"
                $htmlBody += "<td>$($scenario.MemoryUtilization)</td>"
                $htmlBody += "<td>$($scenario.Status)</td>"
                $htmlBody += "</tr>"
            }
            
            $htmlBody += "</table>"
        }
        
        $htmlBody += @"

    <h2>Summary Failure Impact Analysis</h2>
    <table>
        <tr>
            <th>vCenter</th>
            <th>Cluster</th>
            <th>Hosts Down</th>
            <th>Remaining Hosts</th>
            <th>CPU Utilization</th>
            <th>Memory Utilization</th>
            <th>Status</th>
        </tr>
"@
        
        foreach ($row in $failureAnalysis) {
            $htmlBody += "<tr>"
            $htmlBody += "<td>$($row.vCenter)</td>"
            $htmlBody += "<td>$($row.Cluster)</td>"
            $htmlBody += "<td>$($row.HostsDown)</td>"
            $htmlBody += "<td>$($row.RemainingHosts)</td>"
            $htmlBody += "<td>$($row.CPUUtilization)</td>"
            $htmlBody += "<td>$($row.MemoryUtilization)</td>"
            $htmlBody += "<td>$($row.Status)</td>"
            $htmlBody += "</tr>"
        }
        
        $htmlBody += @"
    </table>

    <p><em>Report generated by VMware Capacity Analysis Script</em></p>
</body>
</html>
"@
        
        try {
            $emailParams = @{
                To = $EmailTo
                From = $EmailFrom
                Subject = $EmailSubject
                Body = $htmlBody
                BodyAsHtml = $true
                SmtpServer = $SMTPServer
                Port = $SMTPPort
                UseSsl = $UseSSL
            }
            
            Send-MailMessage @emailParams
            Write-Host "✓ Email report sent successfully to $EmailTo" -ForegroundColor Green
            
        } catch {
            Write-Host "✗ Failed to send email: $($_.Exception.Message)" -ForegroundColor Red
        }
    }
    
} catch {
    Write-Error "Error: $($_.Exception.Message)"
} finally {
    # Disconnect from vCenter
    if ($global:DefaultVIServers) {
        Write-Host "`nDisconnecting from vCenter..." -ForegroundColor Green
        Disconnect-VIServer -Server * -Confirm:$false
    }
}

Write-Host "`nCapacity analysis complete!" -ForegroundColor Green
